# Exercise 4-1 Answer

[Main Menu](../README.md) | [Session 4](../session4/README.md) | [Exercise-4-1 Answer](../session4/Exercise4-1-answer.md)

This is the answer to [Exercise-4-1](../session4/Exercise-4-1.md)

The example below only shows translations for two of the events.

You can see we are extracting the varbind parameter named `.1.3.6.1.4.1.52330.6.2.7.0`.
There is no need for a regular expression because the name of the varbind never changes with the value it represents.
You will remember that in the example traps, this varbind represents the nodelabel. 
THe SQL search uses this value to find the node so that the new event has the correct node name.

```
      <!-- Translations FOR CAMERA CONTROLLER EVENTS -->
      <event-translation-spec uei="uei.opennms.org/traps/CHUBB-TVBS-CAMERA-MIB/healthChange/panMotor">
         <mappings>
            <mapping preserve-snmp-data="false">
               <assignment name="nodeid" type="field">
                  <value type="sql" result="SELECT n.nodeid FROM node n  WHERE n.nodelabel = ? ">
                     <value type="parameter" name=".1.3.6.1.4.1.52330.6.2.7.0" matches=".*" result="${0}" />
                  </value>
               </assignment>
            </mapping>
         </mappings>
      </event-translation-spec>

      <event-translation-spec uei="uei.opennms.org/traps/CHUBB-TVBS-CAMERA-MIB/healthChangeClear/panMotor-clear">
         <mappings>
            <mapping preserve-snmp-data="false">
               <assignment name="nodeid" type="field">
                  <value type="sql" result="SELECT n.nodeid FROM node n  WHERE n.nodelabel = ? ">
                     <value type="parameter" name=".1.3.6.1.4.1.52330.6.2.7.0" matches=".*" result="${0}" />
                  </value>
               </assignment>
            </mapping>
         </mappings>
      </event-translation-spec>
      
```

A complete answer is here with all of the event translations : [translator-configuration.xml](../session4/Exercise4-1-answer/translator-configuration.xml)

---
**NOTE**
* You will need to translate all of the required raise and clear traps. 
  If a simple alarm configuration is adopted which uses the varbind parameter within the reduction and clear keys, then only two translations would be needed. 
---

If you inject a trap through the `camera-controller`, you will see two sets of events and alarms are generated.

```
docker compose exec camera-controller bash


#### panMotor raise
snmptrap -v 2c -c public horizon:1162 ""  .1.3.6.1.4.1.52330.6.2.0.1        .1.3.6.1.4.1.52330.6.2.7.0 s camera_008   .1.3.6.1.4.1.52330.6.2.1.0 i 0  .1.3.6.1.4.1.52330.6.2.5.0 i 1

#### panMotor clear
snmptrap -v 2c -c public horizon:1162 ""  .1.3.6.1.4.1.52330.6.2.0.1        .1.3.6.1.4.1.52330.6.2.7.0 s camera_008   .1.3.6.1.4.1.52330.6.2.1.0 i 0  .1.3.6.1.4.1.52330.6.2.5.0 i 0
```

Firstly an event is generated corresponding to the `camera-controller` and a second event is generated by the event translator corresponding to the node label defined in the cameraIdentifier oid  `.1.3.6.1.4.1.52330.6.2.7.0 s camera_008`

![alt text](../session4/images/eventTransalatorEvents.png "Figure eventTransalatorEvents.png")

## Extra challenge
Unfortunately, there is no simple way to avoid creating the duplicate `camera-controller` events using this configuration.

A solution to this problem would be to enhance the translation so that it creates an event with the uei's we used previously for the actual camera traps. 

You would then add `<logmsg dest="donotpersist">` to the camera-controller trap definitions and make them all `normal` severity.

That way the camera-controller events would never be peristed or displayed but would change into events which apper to come from the cameras themselves.

I will leave it to you to work on this exercise if you wish.


